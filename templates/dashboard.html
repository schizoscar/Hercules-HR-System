{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block header %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Welcome Section with Time Tracking - HORIZONTAL LAYOUT -->
    <div class="dashboard-top-row">
        <div class="welcome-section glass">
            <h2>Welcome, {{ current_user.full_name }}!</h2>
            <p>Today is {{ now.strftime('%A, %B %d, %Y %I:%M %p') }} MYT</p>
            {% if latest_clock_in and latest_clock_in.timestamp.date() == now.date() %}
            <p class="clock-in-time">
                ‚è∞ Clocked in at: {{ latest_clock_in.timestamp.astimezone(MYT).strftime('%H:%M') }} MYT
            </p>
            {% endif %}
        </div>
        
        <!-- Time Tracking Buttons -->
        <div class="time-tracking-section glass">
            <h3>‚è∞ Time Tracking</h3>
            <div class="time-tracking-grid">
                <form id="timeTrackingForm" method="POST" action="{{ url_for('time_tracking') }}">
                    {{ form.hidden_tag() }}
                    <input type="hidden" name="action_type" id="actionType">
                    <input type="hidden" name="latitude" id="latitude">
                    <input type="hidden" name="longitude" id="longitude">
                    <input type="hidden" name="address" id="address">
            
                    {% if not latest_clock_in or latest_clock_in.timestamp.date() != now.date() %}
                    <button type="button" data-action="clock_in" class="time-btn btn-primary" id="clockButton">
                        <span class="btn-icon">üìÖ</span>
                        <span class="btn-text">Clock In</span>
                    </button>
                    {% else %}
                    <button type="button" data-action="clock_out" class="time-btn btn-danger" id="clockButton">
                        <span class="btn-icon">üè†</span>
                        <span class="btn-text">Clock Out</span>
                    </button>
                    {% endif %}
            
                    {% if latest_clock_in and latest_clock_in.timestamp.date() == now.date() and (not latest_lunch_start or latest_lunch_start.timestamp.date() != now.date()) %}
                    <button type="button" data-action="lunch_start" class="time-btn btn-warning" id="lunchButton">
                        <span class="btn-icon">üçΩÔ∏è</span>
                        <span class="btn-text">Start Lunch</span>
                    </button>
                    {% elif latest_lunch_start and latest_lunch_start.timestamp.date() == now.date() and (not latest_lunch_end or latest_lunch_end.timestamp.date() != now.date()) %}
                    <button type="button" data-action="lunch_end" class="time-btn btn-info" id="lunchButton">
                        <span class="btn-icon">‚è±Ô∏è</span>
                        <span class="btn-text">End Lunch</span>
                    </button>
                    {% else %}
                    <button type="button" disabled class="time-btn btn-disabled" id="lunchButton">
                        <span class="btn-icon">üçΩÔ∏è</span>
                        <span class="btn-text">Start Lunch</span>
                    </button>
                    {% endif %}
                </form>
            </div>
        </div>
    </div> <!-- Closing div for dashboard-top-row -->

    <!-- Quick Stats - BELOW THE HORIZONTAL SECTION -->
    <div class="stats-grid">
        <div class="stat-card glass">
            <div class="stat-number">15</div>
            <div class="stat-label">Remaining Leave Days</div>
        </div>
        <div class="stat-card glass">
            <div class="stat-number">3</div>
            <div class="stat-label">Pending Requests</div>
        </div>
        <div class="stat-card glass">
            <div class="stat-number">12</div>
            <div class="stat-label">Approved Leaves</div>
        </div>
    </div>

    <!-- Quick Access Cards - BELOW THE STATS -->
    <div class="quick-access-header">
        <h3>Quick Access</h3>
        <a href="{{ url_for('time_reports') }}" class="btn btn-primary">
            <span>‚è±Ô∏è</span>
            <span>View Time Reports</span>
        </a>
    </div>
    
    <div class="cards-grid">
        {% if current_user.user_type == 'admin' %}
        <!-- Admin Cards -->
        <a href="{{ url_for('manage_employees') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-primary">
                    <span>üë•</span>
                </div>
                <h4>Manage Employees</h4>
            </div>
            <p>Add, edit, and manage employee records and permissions</p>
        </a>

        <a href="{{ url_for('employee_directory') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-info">
                    <span>üìã</span>
                </div>
                <h4>Employee Directory</h4>
            </div>
            <p>Browse and search through all employee contact information</p>
        </a>

        <a href="{{ url_for('leaves') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-success">
                    <span>üå¥</span>
                </div>
                <h4>Leave Management</h4>
            </div>
            <p>Approve, reject, and manage employee leave requests</p>
        </a>

        <a href="{{ url_for('recruitment') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-accent">
                    <span>üíº</span>
                </div>
                <h4>Recruitment</h4>
            </div>
            <p>Manage job postings, applications, and hiring process</p>
        </a>

        {% elif current_user.user_type == 'office' %}
        <!-- Office Employee Cards -->
        <a href="{{ url_for('performance_reviews') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-primary">
                    <span>‚≠ê</span>
                </div>
                <h4>Performance Reviews</h4>
            </div>
            <p>View and manage your performance evaluations and goals</p>
        </a>

        <a href="{{ url_for('leaves') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-success">
                    <span>üå¥</span>
                </div>
                <h4>Leaves Management</h4>
            </div>
            <p>Request, view, and manage your leave applications</p>
        </a>

        <a href="{{ url_for('reports') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-info">
                    <span>üìà</span>
                </div>
                <h4>Reports</h4>
            </div>
            <p>Access and generate various HR reports and analytics</p>
        </a>

        <a href="{{ url_for('settings') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-accent">
                    <span>‚öôÔ∏è</span>
                </div>
                <h4>Settings</h4>
            </div>
            <p>Manage your account settings and preferences</p>
        </a>

        {% elif current_user.user_type == 'supervisor' %}
        <!-- Supervisor Cards -->
        <a href="{{ url_for('leaves') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-success">
                    <span>üå¥</span>
                </div>
                <h4>Leave Management</h4>
            </div>
            <p>Approve, reject, and manage team leave requests</p>
        </a>

        <a href="{{ url_for('employee_directory') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-info">
                    <span>üìã</span>
                </div>
                <h4>Employee Directory</h4>
            </div>
            <p>Browse and search through team member information</p>
        </a>

        <a href="{{ url_for('performance_reviews') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-primary">
                    <span>‚≠ê</span>
                </div>
                <h4>Performance Reviews</h4>
            </div>
            <p>Conduct and manage team performance evaluations</p>
        </a>

        <a href="{{ url_for('reports') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-accent">
                    <span>üìà</span>
                </div>
                <h4>Reports</h4>
            </div>
            <p>Access team performance and attendance reports</p>
        </a>

        {% elif current_user.user_type == 'factory' %}
        <!-- Factory Worker Cards -->
        <a href="{{ url_for('leaves') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-success">
                    <span>üå¥</span>
                </div>
                <h4>Leaves Management</h4>
            </div>
            <p>Request and manage your leave applications</p>
        </a>
        
        <div class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-info">
                    <span>üè≠</span>
                </div>
                <h4>Factory Portal</h4>
            </div>
            <p>Access factory-specific tools and resources</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const timeButtons = document.querySelectorAll('.time-btn:not(.btn-disabled)');
        const form = document.getElementById('timeTrackingForm');
        const actionTypeField = document.getElementById('actionType');
        const latitudeField = document.getElementById('latitude');
        const longitudeField = document.getElementById('longitude');
        const addressField = document.getElementById('address');

        console.log('DOM loaded. Elements found:', {
            timeButtons: timeButtons.length,
            form: !!form,
            actionTypeField: !!actionTypeField,
            latitudeField: !!latitudeField,
            longitudeField: !!longitudeField,
            addressField: !!addressField
        });

        // Check for CSRF token
        const csrfToken = document.querySelector('input[name="csrf_token"]');
        if (!csrfToken) {
            console.error('CSRF token not found in form');
            alert('Form configuration error: CSRF token missing. Please contact support.');
            return;
        } else {
            console.log('CSRF token found:', csrfToken.value);
        }

        // Check for multiple action_type inputs
        const actionTypeInputs = form.querySelectorAll('input[name="action_type"]');
        if (actionTypeInputs.length > 1) {
            console.warn('Multiple action_type inputs found:', actionTypeInputs.length);
            for (let i = 1; i < actionTypeInputs.length; i++) {
                actionTypeInputs[i].remove();
            }
        }

        // Check geolocation support
        if (!navigator.geolocation) {
            console.error('Geolocation not supported by browser');
            alert('Geolocation is not supported by your browser. Time tracking will proceed without location data.');
            timeButtons.forEach(button => button.disabled = true);
            return;
        }

        // Attach event listeners to buttons
        timeButtons.forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const actionType = this.getAttribute('data-action');
                console.log('Button clicked, action:', actionType);

                if (!actionTypeField || !form || !latitudeField || !longitudeField || !addressField) {
                    console.error('Missing elements:', {
                        actionTypeField: !!actionTypeField,
                        form: !!form,
                        latitudeField: !!latitudeField,
                        longitudeField: !!longitudeField,
                        addressField: !!addressField
                    });
                    alert('An error occurred: Form elements not found. Please contact support.');
                    return;
                }

                // Show loading state
                const originalHTML = this.innerHTML;
                this.innerHTML = '<span class="btn-icon">‚è≥</span><span class="btn-text">Getting location...</span>';
                this.disabled = true;

                // Get geolocation
                navigator.geolocation.getCurrentPosition(
                    position => {
                        console.log('Geolocation success:', {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });

                        // Set form values
                        actionTypeField.value = actionType;
                        latitudeField.value = position.coords.latitude;
                        longitudeField.value = position.coords.longitude;

                        // Reverse geocoding
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Geocoding success:', { address: data.display_name || 'Unknown' });
                                addressField.value = data.display_name || 'Unknown location';
                                submitForm(form, this, originalHTML);
                            })
                            .catch(error => {
                                console.error('Geocoding error:', error.message);
                                addressField.value = 'Location lookup failed';
                                submitForm(form, this, originalHTML);
                            });
                    },
                    error => {
                        console.error('Geolocation error:', { code: error.code, message: error.message });
                        let errorMessage = 'Error getting location: ';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += 'Permission denied. Please allow location access.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += 'Position unavailable. Ensure location services are enabled.';
                                break;
                            case error.TIMEOUT:
                                errorMessage += 'Request timed out. Try again in a better signal area.';
                                break;
                            default:
                                errorMessage += `Unknown error (Code ${error.code}).`;
                                break;
                        }
                        alert(`${errorMessage} Proceeding without location data.`);
                        actionTypeField.value = actionType;
                        latitudeField.value = '';
                        longitudeField.value = '';
                        addressField.value = 'Location unavailable';
                        submitForm(form, this, originalHTML);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 8000,
                        maximumAge: 0
                    }
                );
            });
        });

        function submitForm(form, button, originalHTML) {
            try {
                const formData = new FormData(form);
                console.log('Form data before submission:', Object.fromEntries(formData));
                console.log('Attempting native form submission...');
                form.submit();
            } catch (error) {
                console.error('Error in form submission:', error);
                alert('An error occurred while submitting the form. Please try again or contact support.');
                button.innerHTML = originalHTML;
                button.disabled = false;

                // Fallback to XMLHttpRequest
                console.log('Falling back to XMLHttpRequest...');
                const xhr = new XMLHttpRequest();
                xhr.open('POST', form.action, true);
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        console.log('XHR status:', xhr.status, 'Response:', xhr.responseText);
                        if (xhr.status === 200 || xhr.status === 302) {
                            console.log('Submission successful, reloading page...');
                            window.location.reload();
                        } else {
                            console.error('XHR failed:', xhr.status, xhr.responseText);
                            alert('Form submission failed. Please try again or contact support.');
                            button.innerHTML = originalHTML;
                            button.disabled = false;
                        }
                    }
                };
                xhr.send(new FormData(form));
            }
        }

        // Form submission logging
        form.addEventListener('submit', function (e) {
            const formData = new FormData(this);
            console.log('Form submission triggered with data:', Object.fromEntries(formData));
            if (e.defaultPrevented) {
                console.warn('Form submission was prevented');
            }
        });
    });
</script>

<style>
    /* Dashboard Layout Styles */
    .dashboard-top-row {
        display: flex;
        justify-content: space-between;
        align-items: stretch;
        margin-bottom: 30px;
        gap: 20px;
        flex-wrap: wrap;
    }
    
    .welcome-section, .time-tracking-section {
        flex: 1;
        padding: 25px;
        border-radius: 12px;
        min-width: 300px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
    }
    
    .welcome-section {
        justify-content: center;
    }
    
    .welcome-section h2 {
        margin-bottom: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }
    
    .welcome-section p {
        color: #666;
        margin: 0;
    }
    
    .clock-in-time {
        color: #666;
        margin: 10px 0 0 0;
        font-size: 0.9rem;
    }
    
    .time-tracking-section h3 {
        margin-bottom: 20px;
        color: #333;
        text-align: center;
    }
    
    .time-tracking-grid {
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .time-tracking-grid form {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        width: 100%;
    }
    
    .time-btn {
        height: 60px;
        min-width: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 14px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1rem;
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        flex: 1;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .btn-warning {
        background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
        color: #333;
    }
    
    .btn-info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .btn-disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    .time-btn:hover:not(.btn-disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }
    
    .stat-label {
        color: #666;
    }
    
    .quick-access-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .quick-access-header h3 {
        color: #333;
        margin: 0;
    }
    
    .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .dashboard-card {
        display: block;
        padding: 25px;
        border-radius: 12px;
        text-decoration: none;
        color: inherit;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .card-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        color: white;
        font-size: 1.5rem;
    }
    
    .dashboard-card h4 {
        margin: 0;
        color: #333;
    }
    
    .dashboard-card p {
        color: #666;
        margin: 0;
        line-height: 1.5;
    }
    
    .gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .gradient-success {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .gradient-accent {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .dashboard-top-row {
            flex-direction: column;
        }
        
        .welcome-section,
        .time-tracking-section {
            min-width: 100%;
        }
        
        .time-tracking-grid form {
            flex-direction: column;
        }
        
        .time-btn {
            width: 100%;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .quick-access-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        
        .cards-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

{% endblock %}