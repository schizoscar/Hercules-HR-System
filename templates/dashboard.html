{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block header %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Welcome Section with Time Tracking - HORIZONTAL LAYOUT -->
    <div class="dashboard-top-row">
        <div class="welcome-section glass">
            <h2>Welcome, {{ current_user.full_name }}!</h2>
            <p>Today is {{ now.strftime('%A, %B %d, %Y') }}</p>
            {% if current_user.last_clock_in and current_user.last_clock_in.date() == now.date() %}
            <p class="clock-in-time">
                ‚è∞ Clocked in at: {{ current_user.last_clock_in.strftime('%H:%M') }}
            </p>
            {% endif %}
        </div>
        
        <!-- Time Tracking Buttons -->
        <div class="time-tracking-section glass">
            <h3>‚è∞ Time Tracking</h3>
            <div class="time-tracking-grid">
                <form id="timeTrackingForm" method="POST" action="{{ url_for('time_tracking') }}">
                    {{ form.hidden_tag() }}
                    {{ form.action_type(id="actionType") }}
                    {{ form.latitude(id="latitude") }}
                    {{ form.longitude(id="longitude") }}
                    {{ form.address(id="address") }}
                    
                    {% if not current_user.last_clock_in or current_user.last_clock_in.date() != now.date() %}
                    <button type="button" onclick="trackTime('clock_in')" class="time-btn btn-primary" id="clockButton">
                        <span class="btn-icon">üìÖ</span>
                        <span class="btn-text">Clock In</span>
                    </button>
                    {% else %}
                    <button type="button" onclick="trackTime('clock_out')" class="time-btn btn-danger" id="clockButton">
                        <span class="btn-icon">üè†</span>
                        <span class="btn-text">Clock Out</span>
                    </button>
                    {% endif %}
                    
                    {% if current_user.last_clock_in and current_user.last_clock_in.date() == now.date() and (not current_user.last_lunch_start or current_user.last_lunch_start.date() != now.date()) %}
                    <button type="button" onclick="trackTime('lunch_start')" class="time-btn btn-warning" id="lunchButton">
                        <span class="btn-icon">üçΩÔ∏è</span>
                        <span class="btn-text">Start Lunch</span>
                    </button>
                    {% elif current_user.last_lunch_start and current_user.last_lunch_start.date() == now.date() and (not current_user.last_lunch_end or current_user.last_lunch_end.date() != now.date()) %}
                    <button type="button" onclick="trackTime('lunch_end')" class="time-btn btn-info" id="lunchButton">
                        <span class="btn-icon">‚è±Ô∏è</span>
                        <span class="btn-text">End Lunch</span>
                    </button>
                    {% else %}
                    <button type="button" disabled class="time-btn btn-disabled" id="lunchButton">
                        <span class="btn-icon">üçΩÔ∏è</span>
                        <span class="btn-text">Start Lunch</span>
                    </button>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>

    <!-- Quick Stats - BELOW THE HORIZONTAL SECTION -->
    <div class="stats-grid">
        <div class="stat-card glass">
            <div class="stat-number">15</div>
            <div class="stat-label">Remaining Leave Days</div>
        </div>
        <div class="stat-card glass">
            <div class="stat-number">3</div>
            <div class="stat-label">Pending Requests</div>
        </div>
        <div class="stat-card glass">
            <div class="stat-number">12</div>
            <div class="stat-label">Approved Leaves</div>
        </div>
    </div>

    <!-- Quick Access Cards - BELOW THE STATS -->
    <div class="quick-access-header">
        <h3>Quick Access</h3>
        <!-- Time Reports Button for ALL Users -->
        <a href="{{ url_for('time_reports') }}" class="btn btn-primary">
            <span>‚è±Ô∏è</span>
            <span>View Time Reports</span>
        </a>
    </div>
    
    <div class="cards-grid">
        {% if current_user.user_type == 'admin' %}
        <!-- Admin Cards -->
        <a href="{{ url_for('manage_employees') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-primary">
                    <span>üë•</span>
                </div>
                <h4>Manage Employees</h4>
            </div>
            <p>Add, edit, and manage employee records and permissions</p>
        </a>

        <a href="{{ url_for('employee_directory') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-info">
                    <span>üìã</span>
                </div>
                <h4>Employee Directory</h4>
            </div>
            <p>Browse and search through all employee contact information</p>
        </a>

        <a href="{{ url_for('leaves') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-success">
                    <span>üå¥</span>
                </div>
                <h4>Leave Management</h4>
            </div>
            <p>Approve, reject, and manage employee leave requests</p>
        </a>

        <a href="{{ url_for('recruitment') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-accent">
                    <span>üíº</span>
                </div>
                <h4>Recruitment</h4>
            </div>
            <p>Manage job postings, applications, and hiring process</p>
        </a>

        {% elif current_user.user_type == 'office' %}
        <!-- Office Employee Cards -->
        <a href="{{ url_for('performance_reviews') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-primary">
                    <span>‚≠ê</span>
                </div>
                <h4>Performance Reviews</h4>
            </div>
            <p>View and manage your performance evaluations and goals</p>
        </a>

        <a href="{{ url_for('leaves') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-success">
                    <span>üå¥</span>
                </div>
                <h4>Leaves Management</h4>
            </div>
            <p>Request, view, and manage your leave applications</p>
        </a>

        <a href="{{ url_for('reports') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-info">
                    <span>üìà</span>
                </div>
                <h4>Reports</h4>
            </div>
            <p>Access and generate various HR reports and analytics</p>
        </a>

        <a href="{{ url_for('settings') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-accent">
                    <span>‚öôÔ∏è</span>
                </div>
                <h4>Settings</h4>
            </div>
            <p>Manage your account settings and preferences</p>
        </a>

        {% elif current_user.user_type == 'supervisor' %}
        <!-- Supervisor Cards -->
        <a href="{{ url_for('leaves') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-success">
                    <span>üå¥</span>
                </div>
                <h4>Leave Management</h4>
            </div>
            <p>Approve, reject, and manage team leave requests</p>
        </a>

        <a href="{{ url_for('employee_directory') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-info">
                    <span>üìã</span>
                </div>
                <h4>Employee Directory</h4>
            </div>
            <p>Browse and search through team member information</p>
        </a>

        <a href="{{ url_for('performance_reviews') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-primary">
                    <span>‚≠ê</span>
                </div>
                <h4>Performance Reviews</h4>
            </div>
            <p>Conduct and manage team performance evaluations</p>
        </a>

        <a href="{{ url_for('reports') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-accent">
                    <span>üìà</span>
                </div>
                <h4>Reports</h4>
            </div>
            <p>Access team performance and attendance reports</p>
        </a>

        {% elif current_user.user_type == 'factory' %}
        <!-- Factory Worker Cards -->
        <a href="{{ url_for('leaves') }}" class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-success">
                    <span>üå¥</span>
                </div>
                <h4>Leaves Management</h4>
            </div>
            <p>Request and manage your leave applications</p>
        </a>
        
        <!-- Additional factory-specific cards can be added here -->
        <div class="dashboard-card glass">
            <div class="card-header">
                <div class="card-icon gradient-info">
                    <span>üè≠</span>
                </div>
                <h4>Factory Portal</h4>
            </div>
            <p>Access factory-specific tools and resources</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function logErrorToServer(errorData) {
        fetch('/log_error', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(errorData)
        }).catch(err => console.error('Failed to log error to server', err));
    }

    function getGeolocationDiagnostics() {
        return {
            browser: navigator.userAgent,
            geolocationSupported: !!navigator.geolocation,
            permissionsApiSupported: !!navigator.permissions,
            timestamp: new Date().toISOString(),
            platform: navigator.platform,
            isMobile: /Mobi|Android/i.test(navigator.userAgent)
        };
    }

    function trackTime(actionType) {
        const diagnostics = getGeolocationDiagnostics();
        if (!navigator.geolocation) {
            const errorData = {
                error: 'Geolocation not supported',
                action: actionType,
                ...diagnostics
            };
            console.error('Geolocation not supported', errorData);
            logErrorToServer(errorData);
            alert('Geolocation is not supported by your browser. Please try a different browser or enable location services.');
            return;
        }

        // Show loading state
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<span class="btn-icon">‚è≥</span><span class="btn-text">Getting location...</span>';
        button.disabled = true;

        // Retry geolocation
        let attempts = 0;
        const maxAttempts = 3;
        const retryDelay = 2000;

        function tryGetLocation() {
            attempts++;
            const geoTimeout = setTimeout(() => {
                const errorData = {
                    error: 'Geolocation timed out',
                    action: actionType,
                    attempt: attempts,
                    ...diagnostics
                };
                console.error('Geolocation timed out', errorData);
                logErrorToServer(errorData);
                if (attempts < maxAttempts) {
                    console.log(`Retrying geolocation (attempt ${attempts + 1})`);
                    tryGetLocation();
                } else {
                    alert('Location request timed out after multiple attempts. Please check your location services and try again.');
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                    // Fallback: Submit without location
                    submitWithoutLocation(actionType, button, originalHTML);
                }
            }, 10000);

            navigator.geolocation.getCurrentPosition(
                position => {
                    clearTimeout(geoTimeout);
                    const successData = {
                        action: actionType,
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date(position.timestamp).toISOString(),
                        ...diagnostics
                    };
                    console.log('Geolocation success', successData);
                    logErrorToServer({ ...successData, event: 'Geolocation success' });

                    // Set form values
                    document.getElementById('actionType').value = actionType;
                    document.getElementById('latitude').value = position.coords.latitude;
                    document.getElementById('longitude').value = position.coords.longitude;

                    // Reverse geocoding
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Geocoding success', { address: data.display_name || 'Unknown', rawResponse: data });
                            document.getElementById('address').value = data.display_name || 'Unknown location';
                            document.getElementById('timeTrackingForm').submit();
                        })
                        .catch(error => {
                            const errorData = {
                                error: 'Geocoding failed',
                                message: error.message,
                                action: actionType,
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                ...diagnostics
                            };
                            console.error('Geocoding error', errorData);
                            logErrorToServer(errorData);
                            document.getElementById('address').value = 'Location lookup failed';
                            document.getElementById('timeTrackingForm').submit();
                        });
                },
                error => {
                    clearTimeout(geoTimeout);
                    const errorData = {
                        error: 'Geolocation failed',
                        code: error.code,
                        message: error.message || 'No details provided',
                        action: actionType,
                        attempt: attempts,
                        ...diagnostics
                    };

                    if (navigator.permissions) {
                        navigator.permissions.query({ name: 'geolocation' }).then(permissionStatus => {
                            errorData.permissionStatus = permissionStatus.state;
                            console.error('Geolocation error', errorData);
                            logErrorToServer(errorData);
                            handleGeolocationError(error, errorData, actionType, button, originalHTML);
                        }).catch(permError => {
                            errorData.permissionError = permError.message;
                            console.error('Permission check failed', errorData);
                            logErrorToServer(errorData);
                            handleGeolocationError(error, errorData, actionType, button, originalHTML);
                        });
                    } else {
                        console.error('Geolocation error', errorData);
                        logErrorToServer(errorData);
                        handleGeolocationError(error, errorData, actionType, button, originalHTML);
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 8000,
                    maximumAge: 0
                }
            );
        }

        function handleGeolocationError(error, errorData, actionType, button, originalHTML) {
            if (attempts < maxAttempts) {
                console.log(`Retrying geolocation (attempt ${attempts + 1})`);
                setTimeout(tryGetLocation, retryDelay);
                return;
            }

            let errorMessage = 'Error getting location: ';
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += 'Permission denied. Please allow location access in your browser settings and try again.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += 'Position unavailable. Please ensure location services are enabled on your device and try again.';
                    break;
                case error.TIMEOUT:
                    errorMessage += 'Request timed out. Please try again in an area with better GPS signal.';
                    break;
                default:
                    errorMessage += `Unknown error (Code ${error.code}). Please try again or contact support.`;
                    break;
            }

            alert(errorMessage);
            button.innerHTML = originalHTML;
            button.disabled = false;
            // Fallback: Submit without location
            submitWithoutLocation(actionType, button, originalHTML);
        }

        function submitWithoutLocation(actionType, button, originalHTML) {
            const confirmSubmit = confirm('Unable to get location. Would you like to record the action without location data?');
            if (confirmSubmit) {
                document.getElementById('actionType').value = actionType;
                document.getElementById('latitude').value = '';
                document.getElementById('longitude').value = '';
                document.getElementById('address').value = 'Location unavailable';
                document.getElementById('timeTrackingForm').submit();
            }
        }

        tryGetLocation();
    }

    document.addEventListener('DOMContentLoaded', function () {
        const diagnostics = getGeolocationDiagnostics();
        if (!navigator.geolocation) {
            const errorData = {
                error: 'Geolocation not supported on page load',
                ...diagnostics
            };
            console.error('Geolocation not supported', errorData);
            logErrorToServer(errorData);
            document.getElementById('clockButton').disabled = true;
            document.getElementById('lunchButton').disabled = true;
            alert('Your browser does not support geolocation. Time tracking features will not work.');
            return;
        }

        if (navigator.permissions) {
            navigator.permissions.query({ name: 'geolocation' }).then(permissionStatus => {
                const permissionData = {
                    event: 'Geolocation permission check',
                    status: permissionStatus.state,
                    ...diagnostics
                };
                console.log('Geolocation permission status', permissionData);
                logErrorToServer(permissionData);
                if (permissionStatus.state === 'denied') {
                    const errorData = {
                        error: 'Location permission denied on page load',
                        permissionStatus: permissionStatus.state,
                        ...diagnostics
                    };
                    console.error('Permission denied', errorData);
                    logErrorToServer(errorData);
                    alert('Location access is denied. Please enable location permissions in your browser settings to use time tracking.');
                    document.getElementById('clockButton').disabled = true;
                    document.getElementById('lunchButton').disabled = true;
                }
            }).catch(error => {
                const errorData = {
                    error: 'Permission check failed on load',
                    message: error.message,
                    ...diagnostics
                };
                console.error('Permission check error', errorData);
                logErrorToServer(errorData);
            });
        }
    });
</script>

<style>
    /* Dashboard Layout Styles */
    .dashboard-top-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 30px;
        gap: 20px;
        flex-wrap: wrap;
    }
    
    .welcome-section {
        flex: 1;
        padding: 25px;
        border-radius: 12px;
        min-width: 300px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .welcome-section h2 {
        margin-bottom: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }
    
    .welcome-section p {
        color: #666;
        margin: 0;
    }
    
    .clock-in-time {
        color: #666;
        margin: 10px 0 0 0;
        font-size: 0.9rem;
    }
    
    .time-tracking-section {
        flex: 1;
        padding: 25px;
        border-radius: 12px;
        min-width: 300px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .time-tracking-section h3 {
        margin-bottom: 15px;
        color: #333;
        text-align: center;
    }
    
    .time-tracking-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    
    /* Button Styles */
    .time-btn {
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 14px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        font-weight: 600;
        font-size: 1rem;
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .btn-warning {
        background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
        color: #333;
    }
    
    .btn-info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .btn-disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    .time-btn:hover:not(.btn-disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }
    
    .stat-label {
        color: #666;
    }
    
    .quick-access-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .quick-access-header h3 {
        color: #333;
        margin: 0;
    }
    
    .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .dashboard-card {
        display: block;
        padding: 25px;
        border-radius: 12px;
        text-decoration: none;
        color: inherit;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .card-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        color: white;
        font-size: 1.5rem;
    }
    
    .dashboard-card h4 {
        margin: 0;
        color: #333;
    }
    
    .dashboard-card p {
        color: #666;
        margin: 0;
        line-height: 1.5;
    }
    
    .gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .gradient-success {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .gradient-accent {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .dashboard-top-row {
            flex-direction: column;
        }
        
        .welcome-section,
        .time-tracking-section {
            min-width: 100%;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .quick-access-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        
        .cards-grid {
            grid-template-columns: 1fr;
        }
        
        /* Mobile responsive fixes for time tracking */
        .time-btn {
            padding: 12px;
            font-size: 0.9rem;
        }
    }
</style>

{% endblock %}