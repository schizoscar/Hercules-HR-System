{% extends "base.html" %}

{% block title %}Leaves Management{% endblock %}

{% block header %}Leaves Management{% endblock %}

{% block content %}
{% if current_user.user_type in ['admin', 'supervisor'] %}
<!-- Admin/Supervisor View -->
<div style="display: flex; gap: 10px; margin-bottom: 20px;">
    <a href="{{ url_for('all_leaves') }}" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        All Leaves
    </a>
    <a href="{{ url_for('manage_leave_balances') }}" class="btn" style="background: linear-gradient(135deg, #4facfe 0%, #2986cc 100%);">
        Manage Leaves
    </a>
</div>

<h2>Pending Leave Requests</h2>
{% if pending_requests %}

<!-- Desktop Table -->
<table class="pending-requests-table desktop-view" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
    <thead>
        <tr style="background: #f5f5f5;">
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Employee</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Leave Type</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Start Date</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">End Date</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Days</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Reason</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Attachment</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for request in pending_requests %}
        <tr>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.employee.full_name }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.leave_type|title }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.start_date.strftime('%Y-%m-%d') }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.end_date.strftime('%Y-%m-%d') }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.days_requested }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.reason }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">
                {% if request.attachment_filename %}
                    <a href="{{ url_for('download_attachment', filename=request.attachment_filename) }}" target="_blank" style="color: #4361ee; text-decoration: none;">
                        View Attachment
                    </a>
                {% else %}
                    None
                {% endif %}
            </td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <a href="{{ url_for('approve_leave', request_id=request.id) }}" class="btn btn-sm" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        Approve
                    </a>
                    <a href="{{ url_for('reject_leave', request_id=request.id) }}" class="btn btn-sm" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);">
                        Reject
                    </a>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Mobile Cards -->
<div class="mobile-view" style="display: none;">
    {% for request in pending_requests %}
    <div style="border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px;">
        <div style="margin-bottom: 10px;">
            <strong>Employee:</strong> {{ request.employee.full_name }}
        </div>
        <div style="margin-bottom: 10px;">
            <strong>Leave Type:</strong> {{ request.leave_type|title }}
        </div>
        <div style="margin-bottom: 10px;">
            <strong>Dates:</strong> {{ request.start_date.strftime('%Y-%m-%d') }} to {{ request.end_date.strftime('%Y-%m-%d') }}
        </div>
        <div style="margin-bottom: 10px;">
            <strong>Days:</strong> {{ request.days_requested }}
        </div>
        <div style="margin-bottom: 10px;">
            <strong>Reason:</strong> {{ request.reason }}
        </div>
        <div style="margin-bottom: 10px;">
            <strong>Attachment:</strong>
            {% if request.attachment_filename %}
                <a href="{{ url_for('download_attachment', filename=request.attachment_filename) }}" target="_blank" style="color: #4361ee; text-decoration: none;">
                    View Attachment
                </a>
            {% else %}
                None
            {% endif %}
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
            <a href="{{ url_for('approve_leave', request_id=request.id) }}" class="btn btn-sm" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                Approve
            </a>
            <a href="{{ url_for('reject_leave', request_id=request.id) }}" class="btn btn-sm" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);">
                Reject
            </a>
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<p>No pending leave requests.</p>
{% endif %}

{% else %}
<!-- Employee View -->
<h2>Your Leave Balance</h2>
<table style="width: 100%; border-collapse: collapse; margin-top: 10px; margin-bottom: 20px;">
    <thead>
        <tr style="background: #f5f5f5;">
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Leave Type</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Total</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Used</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Remaining</th>
        </tr>
    </thead>
    <tbody>
        {% for balance in current_user.leave_balances %}
        <tr>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ balance.leave_type|title }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">
                {% if balance.leave_type == 'unpaid' %}Unlimited{% else %}{{ balance.total_days }} days{% endif %}
            </td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ balance.used_days }} days</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">
                {% if balance.leave_type == 'unpaid' %}Unlimited{% else %}{{ balance.remaining_days }} days{% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Request Leave Button only -->
<div style="margin-bottom: 30px;">
    <a href="{{ url_for('request_leave') }}" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 24px; font-size: 1rem;">
        Request Leave
    </a>
</div>

<h2>Your Leave History</h2>
{% if user_requests %}
<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
    <thead>
        <tr style="background: #f5f5f5;">
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Leave Type</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Start Date</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">End Date</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Days</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Status</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for request in user_requests %}
        <tr>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.leave_type|title }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.start_date.strftime('%d-%m-%y') }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.end_date.strftime('%d-%m-%y') }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.days_requested }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">
                <span style="
                    padding: 3px 8px;
                    border-radius: 3px;
                    font-size: 0.8rem;
                    {% if request.status == 'approved' %}
                        background: #d4edda; color: #155724;
                    {% elif request.status == 'rejected' %}
                        background: #f8d7da; color: #721c24;
                    {% else %}
                        background: #fff3cd; color: #856404;
                    {% endif %}
                ">
                    {{ request.status|title }}
                </span>
            </td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">
                {% if request.status == 'pending' %}
                <div style="display: flex; gap: 5px;">
                    <a href="{{ url_for('edit_leave', request_id=request.id) }}" 
                       class="btn btn-sm" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        Edit
                    </a>
                    <a href="{{ url_for('delete_leave', request_id=request.id) }}" 
                       class="btn btn-sm" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);"
                       onclick="return confirm('Are you sure you want to delete this leave request?')">
                        Delete
                    </a>
                </div>
                {% else %}
                <em>No actions available</em>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>You haven't submitted any leave requests yet.</p>
{% endif %}
{% endif %}

<style>
    /* Show/hide based on screen size */
    @media (max-width: 768px) {
        .desktop-view {
            display: none;
        }
        .mobile-view {
            display: block;
        }
    }
    @media (min-width: 769px) {
        .mobile-view {
            display: none;
        }
    }
    
    .btn {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: none;
        cursor: pointer;
        text-align: center;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 0.9rem;
    }
</style>
{% endblock %}