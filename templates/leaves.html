{% extends "base.html" %}

{% block title %}Leaves Management{% endblock %}

{% block header %}Leaves Management{% endblock %}

{% block content %}
{% if current_user.user_type in ['admin', 'supervisor'] %}
<!-- Admin/Supervisor View -->
<div style="display: flex; gap: 10px; margin-bottom: 20px;">
    <a href="{{ url_for('leaves') }}" style="background: #3c8dbc; color: white; padding: 10px 15px; border-radius: 4px; text-decoration: none;">
        Pending Requests
    </a>
    <a href="{{ url_for('all_leaves') }}" style="background: #6c757d; color: white; padding: 10px 15px; border-radius: 4px; text-decoration: none;">
        All Leaves
    </a>
</div>

<h2>Pending Leave Requests</h2>
{% if pending_requests %}

<!-- Desktop Table -->
<table class="pending-requests-table desktop-view" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
    <thead>
        <tr style="background: #f5f5f5;">
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Employee</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Leave Type</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Start Date</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">End Date</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Days</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Reason</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Attachment</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for request in pending_requests %}
        <tr>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.employee.full_name }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">
                {{ request.leave_type|title }}
                {% if request.compassionate_type %}
                <br><small>({{ request.compassionate_type|title }})</small>
                {% endif %}
            </td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.start_date.strftime('%Y-%m-%d') }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.end_date.strftime('%Y-%m-%d') }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.days_requested }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.reason }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">
                {% if request.attachment_filename %}
                    <a href="{{ url_for('download_attachment', filename=request.attachment_filename) }}" target="_blank" style="color: #3c8dbc; text-decoration: none;">
                        View Attachment
                    </a>
                {% else %}
                    None
                {% endif %}
            </td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <a href="{{ url_for('approve_leave', request_id=request.id) }}" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 3px; text-decoration: none; text-align: center;">
                        Approve
                    </a>
                    <a href="{{ url_for('reject_leave', request_id=request.id) }}" style="background: #dc3545; color: white; padding: 5px 10px; border-radius: 3px; text-decoration: none; text-align: center;">
                        Reject
                    </a>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Mobile Cards -->
<div class="mobile-view" style="display: none;">
    {% for request in pending_requests %}
    <div style="border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px;">
        <div style="margin-bottom: 10px;">
            <strong>Employee:</strong> {{ request.employee.full_name }}
        </div>
        <div style="margin-bottom: 10px;">
            <strong>Leave Type:</strong> {{ request.leave_type|title }}
            {% if request.compassionate_type %}
            <br><small>({{ request.compassionate_type|title }})</small>
            {% endif %}
        </div>
        <div style="margin-bottom: 10px;">
            <strong>Dates:</strong> {{ request.start_date.strftime('%Y-%m-%d') }} to {{ request.end_date.strftime('%Y-%m-%d') }}
        </div>
        <div style="margin-bottom: 10px;">
            <strong>Days:</strong> {{ request.days_requested }}
        </div>
        <div style="margin-bottom: 10px;">
            <strong>Reason:</strong> {{ request.reason }}
        </div>
        <div style="margin-bottom: 10px;">
            <strong>Attachment:</strong>
            {% if request.attachment_filename %}
                <a href="{{ url_for('download_attachment', filename=request.attachment_filename) }}" target="_blank" style="color: #3c8dbc; text-decoration: none;">
                    View Attachment
                </a>
            {% else %}
                None
            {% endif %}
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
            <a href="{{ url_for('approve_leave', request_id=request.id) }}" style="background: #28a745; color: white; padding: 10px; border-radius: 4px; text-decoration: none; text-align: center;">
                Approve
            </a>
            <a href="{{ url_for('reject_leave', request_id=request.id) }}" style="background: #dc3545; color: white; padding: 10px; border-radius: 4px; text-decoration: none; text-align: center;">
                Reject
            </a>
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<p>No pending leave requests.</p>
{% endif %}

{% else %}
<!-- Employee View -->
<h2>Your Leave Balance</h2>
<table style="width: 100%; border-collapse: collapse; margin-top: 10px; margin-bottom: 30px;">
    <thead>
        <tr style="background: #f5f5f5;">
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Leave Type</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Total</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Used</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Remaining</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">Annual</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">20 days</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">5 days</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">15 days</td>
        </tr>
        <tr>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">Medical</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">14 days</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">2 days</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">12 days</td>
        </tr>
        <tr>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">Maternity</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">90 days</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">0 days</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">90 days</td>
        </tr>
        <tr>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">Compassionate</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">3 days</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">0 days</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">3 days</td>
        </tr>
        <tr>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">Marriage</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">3 days</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">0 days</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">3 days</td>
        </tr>
        <tr>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">Hospitalised</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">60 days</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">0 days</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">60 days</td>
        </tr>
        <tr>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">SOCSO MC</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">Unlimited</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">0 days</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">Unlimited</td>
        </tr>
    </tbody>
</table>

<div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
    <h3>Request Leave</h3>
    <p>Submit a new leave request.</p>
    <a href="{{ url_for('request_leave') }}" style="background: #3c8dbc; color: white; padding: 10px 15px; border-radius: 4px; text-decoration: none; display: inline-block;">
        Request Leave
    </a>
</div>

<h2>Your Leave History</h2>
{% if user_requests %}
<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
    <thead>
        <tr style="background: #f5f5f5;">
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Leave Type</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Start Date</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">End Date</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Days</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Status</th>
        </tr>
    </thead>
    <tbody>
        {% for request in user_requests %}
        <tr>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">
                {{ request.leave_type|title }}
                {% if request.compassionate_type %}
                <br><small>({{ request.compassionate_type|title }})</small>
                {% endif %}
            </td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.start_date.strftime('%Y-%m-%d') }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.end_date.strftime('%Y-%m-%d') }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ request.days_requested }}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">
                <span style="
                    padding: 3px 8px;
                    border-radius: 3px;
                    font-size: 0.8rem;
                    {% if request.status == 'approved' %}
                        background: #d4edda; color: #155724;
                    {% elif request.status == 'rejected' %}
                        background: #f8d7da; color: #721c24;
                    {% else %}
                        background: #fff3cd; color: #856404;
                    {% endif %}
                ">
                    {{ request.status|title }}
                </span>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>You haven't submitted any leave requests yet.</p>
{% endif %}
{% endif %}

<style>
    /* Show/hide based on screen size */
    @media (max-width: 768px) {
        .desktop-view {
            display: none;
        }
        .mobile-view {
            display: block;
        }
    }
    @media (min-width: 769px) {
        .mobile-view {
            display: none;
        }
    }
</style>
{% endblock %}