{% extends "base.html" %}

{% block title %}Factory Dashboard{% endblock %}

{% block header %}Factory Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Welcome Section with Time Tracking -->
    <div class="dashboard-top-row">
        <div class="welcome-section glass">
            <h2>Welcome, {{ current_user.full_name }}!</h2>
            <p>Today is {{ now.strftime('%A, %B %d, %Y') }}</p>
        </div>
        
        <!-- Time Tracking Buttons -->
        <div class="time-tracking-section glass">
            <h3>‚è∞ Time Tracking</h3>
            <div class="time-tracking-grid">
                <form id="timeTrackingForm" method="POST" action="{{ url_for('time_tracking') }}">
                    {{ form.hidden_tag() }}
                    <input type="hidden" name="action_type" id="actionType">
                    
                    {% if not current_user.last_clock_in or current_user.last_clock_in.date() != now.date() %}
                    <button type="button" data-action="clock_in" class="time-btn btn-primary">
                        <span class="btn-icon">üìÖ</span>
                        <span class="btn-text">Clock In</span>
                    </button>
                    {% else %}
                    <button type="button" data-action="clock_out" class="time-btn btn-danger">
                        <span class="btn-icon">üè†</span>
                        <span class="btn-text">Clock Out</span>
                    </button>
                    {% endif %}
                    
                    {% if current_user.last_clock_in and current_user.last_clock_in.date() == now.date() and (not current_user.last_lunch_start or current_user.last_lunch_start.date() != now.date()) %}
                    <button type="button" data-action="lunch_start" class="time-btn btn-warning">
                        <span class="btn-icon">üçΩÔ∏è</span>
                        <span class="btn-text">Start Lunch</span>
                    </button>
                    {% elif current_user.last_lunch_start and current_user.last_lunch_start.date() == now.date() and (not current_user.last_lunch_end or current_user.last_lunch_end.date() != now.date()) %}
                    <button type="button" data-action="lunch_end" class="time-btn btn-info">
                        <span class="btn-icon">‚è±Ô∏è</span>
                        <span class="btn-text">End Lunch</span>
                    </button>
                    {% else %}
                    <button type="button" disabled class="time-btn btn-disabled">
                        <span class="btn-icon">üçΩÔ∏è</span>
                        <span class="btn-text">Start Lunch</span>
                    </button>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>

    <!-- Factory-specific content -->
    <div class="glass">
        <h3>Factory Worker Dashboard</h3>
        <p>This is your specialized factory worker dashboard. You can manage your leave requests and track your time here.</p>
        
        <div class="quick-access-header">
            <a href="{{ url_for('leaves') }}" class="btn btn-primary">
                <span>üå¥</span>
                <span>Manage Leaves</span>
            </a>
            <a href="{{ url_for('time_reports') }}" class="btn btn-secondary">
                <span>‚è±Ô∏è</span>
                <span>View Time Reports</span>
            </a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const timeButtons = document.querySelectorAll('.time-btn:not(.btn-disabled)');
        const form = document.getElementById('timeTrackingForm');
        const actionTypeField = document.getElementById('actionType');

        console.log('DOM loaded. Elements found:', {
            timeButtons: timeButtons.length,
            form: !!form,
            actionTypeField: !!actionTypeField
        });

        // Check for CSRF token
        const csrfToken = document.querySelector('input[name="csrf_token"]');
        if (!csrfToken) {
            console.error('CSRF token not found in form');
            alert('Form configuration error: CSRF token missing. Please contact support.');
            return;
        } else {
            console.log('CSRF token found:', csrfToken.value);
        }

        // Check for multiple action_type inputs
        const actionTypeInputs = form.querySelectorAll('input[name="action_type"]');
        if (actionTypeInputs.length > 1) {
            console.warn('Multiple action_type inputs found:', actionTypeInputs.length);
            // Remove all but the first action_type input
            for (let i = 1; i < actionTypeInputs.length; i++) {
                actionTypeInputs[i].remove();
            }
        }

        // Attach event listeners to buttons
        timeButtons.forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const actionType = this.getAttribute('data-action');
                console.log('Button clicked, action:', actionType);

                if (!actionTypeField || !form) {
                    console.error('Missing elements:', {
                        actionTypeField: !!actionTypeField,
                        form: !!form
                    });
                    alert('An error occurred: Form elements not found. Please contact support.');
                    return;
                }

                try {
                    actionTypeField.value = actionType;
                    console.log('Set actionType to:', actionTypeField.value);

                    // Log form data before submission
                    const formData = new FormData(form);
                    console.log('Form data before submission:', Object.fromEntries(formData));

                    // Try native form submission
                    console.log('Attempting native form submission...');
                    form.submit();
                } catch (error) {
                    console.error('Error in button click handler:', error);
                    alert('An error occurred while submitting the form. Please try again or contact support.');

                    // Fallback to XMLHttpRequest
                    console.log('Falling back to XMLHttpRequest...');
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', form.action, true);
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === XMLHttpRequest.DONE) {
                            console.log('XHR status:', xhr.status, 'Response:', xhr.responseText);
                            if (xhr.status === 200 || xhr.status === 302) {
                                console.log('Submission successful, reloading page...');
                                window.location.reload();
                            } else {
                                console.error('XHR failed:', xhr.status, xhr.responseText);
                                alert('Form submission failed. Please try again or contact support.');
                            }
                        }
                    };
                    xhr.send(new FormData(form));
                }
            });
        });

        // Form submission logging
        form.addEventListener('submit', function (e) {
            const formData = new FormData(this);
            console.log('Form submission triggered with data:', Object.fromEntries(formData));
            if (e.defaultPrevented) {
                console.warn('Form submission was prevented');
            }
        });
    });
</script>

<style>
    /* Dashboard Layout Styles */
    .dashboard-top-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 30px;
        gap: 20px;
        flex-wrap: wrap;
    }
    
    .welcome-section {
        flex: 1;
        padding: 25px;
        border-radius: 12px;
        min-width: 300px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .welcome-section h2 {
        margin-bottom: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }
    
    .welcome-section p {
        color: #666;
        margin: 0;
    }
    
    .clock-in-time {
        color: #666;
        margin: 10px 0 0 0;
        font-size: 0.9rem;
    }
    
    .time-tracking-section {
        flex: 1;
        padding: 25px;
        border-radius: 12px;
        min-width: 300px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .time-tracking-section h3 {
        margin-bottom: 15px;
        color: #333;
        text-align: center;
    }
    
    .time-tracking-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    
    /* Button Styles */
    .time-btn {
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 14px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        font-weight: 600;
        font-size: 1rem;
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .btn-warning {
        background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
        color: #333;
    }
    
    .btn-info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .btn-disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    .time-btn:hover:not(.btn-disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }
    
    .stat-label {
        color: #666;
    }
    
    .quick-access-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .quick-access-header h3 {
        color: #333;
        margin: 0;
    }
    
    .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .dashboard-card {
        display: block;
        padding: 25px;
        border-radius: 12px;
        text-decoration: none;
        color: inherit;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .card-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        color: white;
        font-size: 1.5rem;
    }
    
    .dashboard-card h4 {
        margin: 0;
        color: #333;
    }
    
    .dashboard-card p {
        color: #666;
        margin: 0;
        line-height: 1.5;
    }
    
    .gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .gradient-success {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .gradient-accent {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .dashboard-top-row {
            flex-direction: column;
        }
        
        .welcome-section,
        .time-tracking-section {
            min-width: 100%;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .quick-access-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        
        .cards-grid {
            grid-template-columns: 1fr;
        }
        
        /* Mobile responsive fixes for time tracking */
        .time-btn {
            padding: 12px;
            font-size: 0.9rem;
        }
    }
</style>

{% endblock %}